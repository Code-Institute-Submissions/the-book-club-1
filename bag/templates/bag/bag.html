{% extends "base.html" %} {% load static %} {% load bag_tools %} 

{% block extra_css %}
<link rel="stylesheet" href="{% static 'bag/css/bag.css' %}" />
{% endblock %} 


{% block content %}
<div class="container header-container">
   <button onclick="topFunction()" id="backToTopBtn" title="Back to top">Top</button>

  <div class="row align-center margin-botton-5  mb-sm-2">
    <div class="col">
      <h4>
        Shopping Bag
      </h4>
    </div>
  </div>

  <div class="row margin-botton-5">
    <div class="col">
      {% if bag_items %}

      <!-- Grid view for small to medium screens -->
      <div class="d-block d-md-none">
        <div class="row">
          <div class="col mb-1">
            <h6>
              <strong
                >Bag Total ({{product_count}} items): €{{ price_total|floatformat:2 }}</strong
              >
            </h6>
          </div>
        </div>
        <div class="row">
          <div class="col mb-1">
             {% include "bag/bag_action_buttons.html" %}
         </div>
        </div>
         <div class="row">
          <div class="col align-center mb-2 margin-top-3">
            <h4>
              <strong
                >Bag Content</strong
              >
            </h4>
          </div>
        </div>   
        {% for item in bag_items %}
        <div class="row">
        
          <div class="col-12 col-sm-6 mb-2">
                       {% include "bag/product_image.html" %}
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-sm-6 mb-2">
             {% include "bag/product_details.html" %}
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-sm-6 mb-2"></div>
        </div>
        <div class="row">
          <div class="col-12 col-sm-6 mb-2"></div>
        </div>
      </div>
      {% endfor %}


      <!-- Table for medium screens and above -->
      <div class="table-responsive-xm d-none d-md-block">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">Book/Plan</th>
              <th scope="col"></th>
              <th scope="col">Price</th>
              <th scope="col">Qty</th>
              <th scope="col">Subtotal</th>
              <th scope="col">Remove</th>
            </tr>
          </thead>

          <tbody>
            {% for item in bag_items %}

            <tr>
              <th scope="row">
                       {% include "bag/product_image.html" %}

               <!--  {% if item.book != None %}
                
                 {% if item.book.image %}
                  <a href="{% url 'book_detail' item.book.id %}">   <img class="w-100" src="{{ item.book.image.url }}" alt="{{ book.title }}"> </a>
                {% else %}
                  <a href="{% url 'book_detail' item.book.id %}">   <img class="w-100" src="{{ MEDIA_URL }}noimage.jpg" alt="{{ book.title }}"> </a>
                {% endif %}
               
                {% else %}
             
             <a href="{% url 'view_custom_plan_details' item.plan.id %}">
               <img
                  class="img-fluid rounded"
                  src="{{ MEDIA_URL }}plan_image.jpg"
                  alt="Plan image"
                />
             </a>
                {% endif %} -->
                
              </th>
              <td class="w-25">
                {% if item.book != None %}
               <a href="{% url 'book_detail' item.book.id %}">   <p><strong>{{ item.book.title }}</strong></p> </a>
                <p>{{ item.book.author }}</p>
                {% else %}
                 <a href="{% url 'view_custom_plan_details' item.plan.id %}">
                <p><strong>{{ item.plan.name }}</strong></p></a>
                <p>Plan duration: {{ item.plan.plan_duration }} months</p>
                 
                {% endif %}
              </td>

              <td class="w-25">
                {% if item.book != None %}
                <p>€{{ item.book.price }}</p>
                {% else %}
                <p>€{{ item.plan.price }}</p>
                {% endif %}
              </td>
              <td class="w-25">

              {% if item.book != None %}
                  <!-- Update Quantity inside the bag form -->
                <form
                  class="form update-form"
                  method="POST"
                  action="{% url 'adjust_bag' item.item_id %}"
                >
                  {% csrf_token %}
                  <div class="form-group">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <button
                          class="decrement-qty btn btn-sm"
                          data-item_id="{{ item.item_id }}"
                          id="decrement-qty_{{ item.item_id }}"
                        >
                          <span>
                            <i class="fas fa-minus fa-sm"></i>
                          </span>
                        </button>
                      </div>
                      <input
                        class="form-control form-control-sm qty_input"
                        type="number"
                        name="quantity"
                        value="{{ item.quantity }}"
                        min="1"
                        max="99"
                        data-item_id="{{ item.item_id }}"
                        id="id_qty_{{ item.item_id }}"
                      />
                      <div class="input-group-append">
                        <button
                          class="increment-qty btn btn-sm"
                          data-item_id="{{ item.item_id }}"
                          id="increment-qty_{{ item.item_id }}"
                        >
                          <span>
                            <i class="fas fa-plus fa-sm"></i>
                          </span>
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                <a class="update-link text-info"><small>Update</small></a>



         <!-- Plan Quantity is always 1 -->

                {% else %}
                <p><strong>1</strong></p>
                {% endif %}
              </td>

         <!-- Subtotals -->

              <td class="w-25">
              {% if item.book != None %}
                <p>€{{ item.book.price | calc_subtotal:item.quantity }}</p>
                {% else %}
                <p>€{{ item.plan.price }}</p>
                {% endif %}
              </td>


         <!-- Remove buttons -->


              <td class="w-25">
                {% if item.book != None %}
                <a
                  class="remove-item-book text-danger float-right"
                  id="remove_{{ item.item_id }}"
                  ><small>Remove</small></a
                >
                {% else %}
                <a
                  class="remove-item-plan text-danger float-right"
                  id="remove_plan_{{ item.item_id }}"
                  ><small>Remove</small></a
                >
                {% endif %}
              </td>
            </tr>
            {% endfor %}

            <tr>
              <td colspan="5" class="pt-5 text-right">
                <h6>
                  <strong>Bag Total: €{{ price_total|floatformat:2 }}</strong>
                </h6>
              </td>
            </tr>
            <tr>
              <td colspan="5" class="text-right">
                <a href="{% url 'books' %}" class="btn btn-light mobile-button">
                  <span class="icon">
                    <i class="fas fa-chevron-left"></i>
                  </span>
                  <span class="text-uppercase">Keep Shopping</span>
                </a>
                <a href="{% url 'checkout' %}" class="btn mobile-button">
                  <span class="text-uppercase">Checkout</span>
                  <span class="icon">
                    <i class="fas fa-lock"></i>
                  </span>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
      
      <p>Your bag is empty.</p>
      <a href="{% url 'books' %}" class="btn btn-lg btn-light">
        <span class="icon">
          <i class="fas fa-chevron-left"></i>
        </span>
        <span class="text-uppercase">Keep Shopping</span>
      </a>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %} {% block postloadjs %}

 {{ block.super }} {% include 'products/includes/quantity_input_script.html' %}
<script>
  /* As this code relies on the csrf token, it stops working when exported into a separate file */
  // Update quantity on click
  $(".update-link").click(function (e) {
    var form = $(this).prev(".update-form");
    form.submit();
  });
  // Remove item and reload on click - books
  $(".remove-item-book").click(function (e) {
    var csrfToken = "{{ csrf_token }}";
    var itemId = $(this).attr("id").split("remove_")[1];
    var url = `/bag/remove/${itemId}/`;
    var data = { csrfmiddlewaretoken: csrfToken };
    $.post(url, data).done(function () {
      location.reload();
    });
  });
  // Remove item and reload on click - plans
  $(".remove-item-plan").click(function (e) {
    var csrfToken = "{{ csrf_token }}";
    var itemId = $(this).attr("id").split("remove_plan_")[1];
    var url = `/bag/remove_plan/${itemId}/`;
    var data = { csrfmiddlewaretoken: csrfToken };
    $.post(url, data).done(function () {
      location.reload();
    });
  });
</script>


{% endblock %}